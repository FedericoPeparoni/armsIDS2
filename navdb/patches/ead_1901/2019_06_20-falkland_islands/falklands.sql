--------------------------------------------------------------------------------
-- Description: Addition of missing falkland islands and correction of SAVF   --
--              FIR south pole coordinates.                                   --
--                                                                            --
-- 1) Add additional coordinate point at the pole for SAVF airspace           --
--      From: [...,-10 -90,...]                                               --
--      To  : [...,-10 -90,-74 -90,...]                                       --
--                                                                            --
-- 2) Add falkland islands (CTRAGRA) and cut out from SAVF airspace.          --
--      SAVF_X0: SAVF with CTRAGRA cut out.                                   --
--      SAVF_X1: SAVF with CTRAGRA cut out and CTRAGRA segmentized            --
--               to 1000 meters.                                              --
--      SAVF_X2: SAVF with CTRAGRA cut out, CTRAGRA segmentized to            --
--               1000 meters, and narrow cut from CTRAGRA to outside          --
--               SAVF border.                                                 --
--                                                                            --
-- Authors: Davelet Panech, Samuel Craymer                                    --
-- Date: 2019-02-11, 2019-06-20                                               --
-- Ref: TFS-107540                                                            --
--------------------------------------------------------------------------------

-- SAVF: update existing SAVF airspace to add additional south pole coordinate [-74 -90]
update navdb.airspace set geom = 
    ST_GeomFromText(
        'MULTIPOLYGON(((-70.4612166666667 -41.3360444444444,-63.1166666666667 -39.2833333333333,-45 -46,-10 -46,-10 -90,-74 -90,-74 -60,-67.2666666666667 -60,-67.2666666666667 -58.3516666666667,-67.2666666666667 -56.4766666666667,-67.2666666666667 -56.38,-65.7333333333333 -56.38,-65.7266666666667 -55.3816666666667,-66.0783333333333 -55.1833333333333,-66.4166666666667 -55.1216666666667,-66.8333333333333 -55,-67.27045 -54.9108305555556,-68.6579138888889 -54.9190277777778,-68.6105555555555 -53.5733333333333,-68.6383722222222 -52.6754833333333,-68.4576166666667 -52.3586361111111,-69.2575 -52.1708833333333,-69.4839833333333 -52.1679361111111,-69.8 -52.0666666666667,-70.0435861111111 -52.0102416666667,-70.5897222222222 -52.0141666666667,-71.9559138888889 -52.0130527777778,-71.9863083333333 -51.8947611111111,-72.4304944444444 -51.5838805555556,-72.285 -51.2562416666667,-72.41455 -51.1573166666667,-72.3001361111111 -51.0385027777778,-72.3110972222222 -50.6441805555556,-72.78945 -50.6257916666667,-73.0721361111111 -50.782325,-73.1876138888889 -50.7753305555556,-73.5548611111111 -50.3150833333333,-73.5330027777778 -50.1595444444444,-73.4676083333333 -50.0462694444444,-73.5713694444444 -49.9287055555556,-73.4416666666667 -49.8019666666667,-73.6075611111111 -49.5556666666667,-73.4611861111111 -49.3222916666667,-73.495 -49.1566666666667,-73.1856527777778 -49.1931527777778,-72.8431472222222 -48.9636472222222,-72.600325 -48.8215861111111,-72.6329861111111 -48.5051,-72.3229222222222 -48.3665972222222,-72.3258805555556 -48.20075,-72.5770416666667 -47.8801333333333,-72.3415777777778 -47.6068416666667,-72.3578222222222 -47.4344111111111,-72.1651388888889 -47.4098027777778,-71.9887388888889 -47.2084888888889,-71.8490527777778 -47.211975,-71.9762694444444 -47.0624944444444,-71.9583333333333 -47,-71.9264333333333 -46.7907055555556,-71.8252138888889 -46.7822888888889,-71.6692861111111 -46.5836055555556,-71.90775 -46.1411833333333,-71.7333416666667 -46.0677555555556,-71.6574083333333 -45.9197805555556,-71.8028361111111 -45.5909055555556,-71.5218833333333 -45.5263555555556,-71.3560805555556 -45.2225388888889,-71.5821611111111 -44.9659861111111,-72.0225472222222 -44.8990555555556,-72.0268027777778 -44.8022,-71.5093083333333 -44.7390305555556,-71.32035 -44.8024694444444,-71.1177805555556 -44.54635,-71.237775 -44.4091388888889,-71.8486416666667 -44.3806694444444,-71.8436833333333 -44.1088777777778,-71.6863861111111 -43.9967916666667,-71.7830583333333 -43.8200277777778,-71.6012555555556 -43.6831,-71.9364555555556 -43.4903444444444,-71.90245 -43.3377222222222,-71.7541444444444 -43.3007166666667,-71.7497694444444 -43.1753611111111,-72.1254638888889 -43.0552305555556,-72.14495 -42.6123694444444,-72.105 -42.6083333333333,-72.0283027777778 -42.4868472222222,-72.1250166666667 -42.3232694444444,-72.0486305555555 -42.1528444444444,-71.7418388888889 -42.1453138888889,-71.78775 -42.0010888888889,-71.771375 -41.8212916666667,-71.8872222222222 -41.6554111111111,-71.8741444444444 -41.4100361111111,-71.8449405649983 -41.4426122871014,-71.8141734257097 -41.4737162572153,-71.7819171473119 -41.5032730892645,-71.748249438005 -41.5312115782515,-71.7132514062496 -41.5574644179094,-71.6770073653696 -41.5819683628479,-71.6396046304343 -41.6046643809173,-71.601133307908 -41.6254977954223,-71.5616860785766 -41.6444184168424,-71.5213579742705 -41.6613806637435,-71.4802461489254 -41.676343672587,-71.4384496445295 -41.689271396174,-71.3960691525229 -41.700132690486,-71.3532067712229 -41.7089013897137,-71.3099657598604 -41.7155563692927,-71.2664502898191 -41.7200815967942,-71.2227651936779 -41.7224661705488,-71.1790157126598 -41.7227043459095,-71.1353072430966 -41.7207955490909,-71.0917450825198 -41.7167443785518,-71.0484341759899 -41.7105605939168,-71.0054788632743 -41.7022590924649,-70.9629826274837 -41.69185987324,-70.9210478457724 -41.6793879888722,-70.8797755427027 -41.6648734852234,-70.8392651468676 -41.648351329004,-70.7996142513589 -41.6298613235357,-70.7609183786571 -41.6094480128612,-70.7232707505087 -41.5871605744338,-70.6867620633475 -41.5630527006449,-70.6514802697987 -41.537182469474,-70.6175103667933 -41.509612204574,-70.5849341908029 -41.4804083251279,-70.553830220689 -41.4496411858393,-70.5242733886399 -41.4173849074415,-70.4963348996529 -41.3837171981346,-70.470082059995 -41.3487191663792,-70.4612166666667 -41.3360444444444)))', 4326
    )
where ident = 'SAVF' and typ = 'FIR';

-- CTRAGRA: insert CTR MONTE AGRADABLE WITH GEOMETRY
delete from navdb.airspace where ident = 'CTRAGRA' and typ = 'CTR';
insert into navdb.airspace values((select max(airspace_pk) + 1 from navdb.airspace), '2015-05-28 00:00:00', '2015-10-27 16:28:41.194209', 'aixmimporter', 'aixmimporter', NULL, (select max(airspace_pk) + 1 from navdb.airspace), NULL, 'A', 'CTR', 'CTRAGRA', NULL, NULL, 'MONTE AGRADABLE', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2015-05-28 00:00:00', 'infinity');
update navdb.airspace set geom = 
    ST_GeomFromText(
        'MULTIPOLYGON(((-62.481541969811467 -52.02906235479422, -62.4768562072151 -52.067490261036546, -62.456153490082549 -52.217526093932932, -62.413185368557222 -52.361693838172506, -62.360313699630218 -52.500591771975508, -62.296716140058592 -52.6470486784646, -62.216399123059709 -52.781279988040943, -62.12317132654163 -52.916558016114557, -62.044503534705896 -53.010699956972125, -62.007810529561283 -53.047287864420625, -61.920415857549827 -53.141127309927263, -58.392674736218083 -53.078184100458898, -58.337540361386026 -53.07735153773389, -58.094444000261326 -53.064646563009617, -57.856544004633001 -53.034384790833883, -57.622915358126299 -52.983540285864947, -57.408378122435508 -52.918947461574241, -57.203190919677233 -52.840595544236308, -57.01480328245551 -52.743993138872817, -56.854599415647186 -52.639871448328286, -56.702832367376679 -52.519087754821101, -56.588012586164211 -52.391500023292515, -56.495353362190301 -52.256730333258126, -56.429343905478618 -52.116128305534041, -56.399701608706501 -52.000348879729785, -56.391552837547032 -51.968850917087671, -56.381132683064699 -51.818370569991387, -56.40093655901174 -51.669897819069547, -56.446136775645179 -51.526609077535781, -56.517660969049096 -51.386561152158002, -56.612604818054976 -51.251531825355087, -56.733454294670942 -51.124648141080087, -56.885073512679867 -51.009168514586513, -57.049199827125854 -50.904827073332577, -57.233043468205814 -50.806034429145093, -57.424074158108596 -50.727434465383617, -57.636615723601317 -50.663850805020878, -57.85293561369275 -50.613643715985631, -58.088211341483877 -50.581638183700555, -58.314569303978381 -50.566702153077131, -58.491369302717665 -50.563725556602407, -61.90113057766181 -50.567550070763275, -61.974508355305474 -50.643765540345143, -62.072695714230321 -50.779543953388171, -62.175018781996926 -50.907339903802104, -62.267155802494045 -51.05665293171964, -62.329253039243575 -51.192856945762948, -62.391735577806969 -51.341102828745285, -62.434396263951065 -51.478715378604832, -62.467805783424488 -51.62715378247082, -62.48082714915278 -51.771078998885088, -62.481541969811467 -52.02906235479422)))', 4326
    )
where airspace_pk = (select max(airspace_pk) from navdb.airspace);
 
-- SAVF_X0: bogus FIR_P that is a copy of SAVF, but with Falklands CTR cut out
delete from navdb.airspace where ident = 'SAVF_X0' and typ = 'FIR_P';
insert into navdb.airspace values((select max(airspace_pk) + 1 from navdb.airspace), '2015-05-28 00:00:00', '2015-10-27 16:28:41.194209', 'aixmimporter', 'aixmimporter', NULL, (select max(airspace_pk) + 1 from navdb.airspace), NULL, 'A', 'FIR_P', 'SAVF_X0', NULL, NULL, 'COMODORO RIVADAVIA FIR - X0', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2015-05-28 00:00:00', 'infinity');
update navdb.airspace set geom =
	ST_SetSRID(
		ST_Multi(
			ST_difference(
				(select geom from navdb.airspace where ident = 'SAVF' and typ = 'FIR'),
				(select geom from navdb.airspace where ident = 'CTRAGRA' and typ = 'CTR')
			)
		), 4326
	)
where ident = 'SAVF_X0' and typ = 'FIR_P';

-- SAVF_X1: same as above, but with the inner geometry segmentized at 1000 meters
delete from navdb.airspace where ident = 'SAVF_X1' and typ = 'FIR_P';
insert into navdb.airspace values((select max(airspace_pk) + 1 from navdb.airspace), '2015-05-28 00:00:00', '2015-10-27 16:28:41.194209', 'aixmimporter', 'aixmimporter', NULL, (select max(airspace_pk) + 1 from navdb.airspace), NULL, 'A', 'FIR_P', 'SAVF_X1', NULL, NULL, 'COMODORO RIVADAVIA FIR - X1', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2015-05-28 00:00:00', 'infinity');
update navdb.airspace set geom =
	ST_SetSRID(
		ST_Multi(
			ST_difference(
				(select geom from navdb.airspace where ident = 'SAVF' and typ = 'FIR'),
				(select ST_Segmentize (geom::geography, 1000)::geometry from navdb.airspace where ident = 'CTRAGRA' and typ = 'CTR')
			)
		), 4326
	)
where ident = 'SAVF_X1' and typ = 'FIR_P';

-- SAVF_X2: same as above, but with a narrow cut from the inner Falklands plygon to the outside border polygon
delete from navdb.airspace where ident = 'SAVF_X2' and typ = 'FIR_P';
insert into navdb.airspace values((select max(airspace_pk) + 1 from navdb.airspace), '2015-05-28 00:00:00', '2015-10-27 16:28:41.194209', 'aixmimporter', 'aixmimporter', NULL, (select max(airspace_pk) + 1 from navdb.airspace), NULL, 'A', 'FIR_P', 'SAVF_X2', NULL, NULL, 'COMODORO RIVADAVIA FIR - X2', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, '2015-05-28 00:00:00', 'infinity');
update navdb.airspace set geom =
	ST_SetSRID(
		ST_Multi(
			ST_difference(
				(select geom from navdb.airspace where ident = 'SAVF_X1' and typ = 'FIR_P'),
				ST_SetSrid(
					ST_Buffer(
						ST_Segmentize (ST_SetSrid (ST_MakeLine(ST_MakePoint(-65.7266666666667, -55.3816666666667), ST_MakePoint(-61.920415857549806, -53.1411273099273)), 4326)::geography, 1000),
						0.01)::geometry,
					4326
				)
			)
		), 4326
	)
where ident = 'SAVF_X2' and typ = 'FIR_P';
